<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>神社検定2のテスト - 問題</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="quiz-container">
    <!-- ここに問題と選択肢が表示されます -->
  </div>

  <script>
    const username = sessionStorage.getItem('username');
    const examRound = sessionStorage.getItem('examRound');
    const questionCount = parseInt(sessionStorage.getItem('questionCount'));

    if (!username || !examRound || !questionCount) {
      document.body.innerHTML = '<p>エラー：必要なデータが見つかりません。最初からやり直してください。</p>';
      throw new Error("Missing sessionStorage values");
    }

    const container = document.getElementById("quiz-container");
    container.innerHTML = `<p>${username} さん（第${examRound}回）の試験を ${questionCount} 問で開始します。</p>`;

    let currentIndex = 0;
    let score = 0;
    let questions = [];

    async function loadQuestions() {
      try {
        const response = await fetch(`questions_${examRound}.json`);
        const allQuestions = await response.json();
        validateQuestions(allQuestions);  // バリデーション呼び出し
        questions = allQuestions.slice(0, questionCount);
        showQuestion();
      } catch (error) {
        container.innerHTML = '<p>問題データの読み込みに失敗しました。</p>';
        console.error(error);
      }
    }

    function validateQuestions(qList) {
      if (!Array.isArray(qList)) throw new Error("JSONデータが配列ではありません");
      qList.forEach((q, i) => {
        if (!q.question || typeof q.question !== 'string') {
          throw new Error(`第${i + 1}問：'question'フィールドが無効です`);
        }
        if (!Array.isArray(q.choices) || q.choices.length < 2) {
          throw new Error(`第${i + 1}問：選択肢が2つ未満です`);
        }
        if (typeof q.answer !== 'number' || q.answer < 0 || q.answer >= q.choices.length) {
          throw new Error(`第${i + 1}問：'answer'フィールドが無効です`);
        }
      });
    }

    function showQuestion() {
      if (currentIndex >= questions.length) {
        container.innerHTML = `<p>テスト終了！正解数: ${score} / ${questions.length}</p>`;
        return;
      }

      const q = questions[currentIndex];
      let html = `<h2>問${currentIndex + 1}：${q.question}</h2><ul>`;
      q.choices.forEach((choice, index) => {
        html += `<li><button onclick="answer(${index})">${choice}</button></li>`;
      });
      html += '</ul>';
      container.innerHTML = html;
    }

    function answer(selected) {
      const q = questions[currentIndex];
      if (selected === q.answer) score++;
      currentIndex++;
      showQuestion();
    }

    loadQuestions();
  </script>
</body>
</html>
