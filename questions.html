<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>神社検定2のテスト - 問題</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="quiz-container">
    <!-- ここに問題と選択肢が表示されます -->
  </div>

  <script>
    const username = sessionStorage.getItem('username');
    const examRound = sessionStorage.getItem('examRound');
    const questionCount = parseInt(sessionStorage.getItem('questionCount'));

    if (!username || !examRound || !questionCount) {
      document.body.innerHTML = '<p>エラー：必要なデータが見つかりません。最初からやり直してください。</p>';
      throw new Error("Missing sessionStorage values");
    }

    const container = document.getElementById("quiz-container");
    container.innerHTML = `<p>${username} さん（第${examRound}回）の試験を ${questionCount} 問で開始します。</p>`;

    let currentIndex = 0;
    let score = 0;
    let questions = [];

    async function loadQuestions() {
      try {
        const response = await fetch(`questions_${examRound}.json`);
        const allQuestions = await response.json();

        // 検証部分ここから
        const errors = [];
        const idSet = new Set();
        allQuestions.forEach((q, i) => {
          if (idSet.has(q.id)) {
            errors.push(`重複ID: ${q.id}`);
          } else {
            idSet.add(q.id);
          }
          if (q.exam !== 12) {
            errors.push(`id ${q.id}: exam !== 12`);
          }
          if (!/^12-\d+$/.test(q.group)) {
            errors.push(`id ${q.id}: group形式エラー (${q.group})`);
          }
          if (typeof q.question !== 'string' || q.question.trim() === '') {
            errors.push(`id ${q.id}: questionが不正`);
          }
          if (!Array.isArray(q.choices) || q.choices.length !== 4) {
            errors.push(`id ${q.id}: choicesが4つでない`);
          }
          if (typeof q.answer !== 'number' || q.answer < 0 || q.answer > 3) {
            errors.push(`id ${q.id}: answerが0～3でない`);
          }
          if (typeof q.commentary !== 'string' || q.commentary.trim() === '') {
            errors.push(`id ${q.id}: commentaryが不正`);
          }
        });
        if (errors.length > 0) {
          console.error("検証エラー:\n" + errors.join("\n"));
        } else {
          console.log("questions_12.json の検証に成功しました。");
        }
        // 検証部分ここまで

        questions = allQuestions.slice(0, questionCount);
        showQuestion();
      } catch (error) {
        container.innerHTML = '<p>問題データの読み込みに失敗しました。</p>';
        console.error(error);
      }
    }

    function showQuestion() {
      if (currentIndex >= questions.length) {
        container.innerHTML = `<p>テスト終了！正解数: ${score} / ${questions.length}</p>`;
        return;
      }

      const q = questions[currentIndex];
      let html = `<h2>問${currentIndex + 1}：${q.question}</h2><ul>`;
      q.choices.forEach((choice, index) => {
        html += `<li><button onclick="answer(${index})">${choice}</button></li>`;
      });
      html += '</ul>';
      container.innerHTML = html;
    }

    function answer(selected) {
      const q = questions[currentIndex];
      if (selected === q.answer) score++;
      currentIndex++;
      showQuestion();
    }

    loadQuestions();
  </script>
</body>
</html>
